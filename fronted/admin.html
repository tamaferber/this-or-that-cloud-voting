<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>

<style>
body {
  margin: 0;
  min-height: 100vh;
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background: linear-gradient(135deg, #f3e7ff, #e6d6ff);
  display: flex;
  align-items: center;
  justify-content: center;
}

.card {
  background: white;
  padding: 50px 60px;
  border-radius: 24px;
  box-shadow: 0 10px 40px rgba(120, 80, 200, 0.25);
  text-align: center;
  width: 420px;
}

h1 {
  font-size: 26px;
  margin-bottom: 30px;
  color: #5a2d82;
}

.bar-container {
  margin-top: 20px;
}

.label {
  text-align: left;
  font-weight: 600;
  margin-bottom: 6px;
  color: #5a2d82;
}

.bar-bg {
  background: #eee;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
}

.bar {
  height: 28px;
  width: 0%;
  transition: width 0.4s ease;
}

.barA {
  background: linear-gradient(135deg, #b983ff, #9b5de5);
}

.barB {
  background: linear-gradient(135deg, #ff9ecb, #f15bb5);
}

.nav {
  margin-top: 30px;
  display: flex;
  justify-content: space-between;
}

button {
  font-size: 16px;
  padding: 10px 24px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  background: linear-gradient(135deg, #b983ff, #9b5de5);
  color: white;
  font-weight: 600;
}
</style>
</head>
<body>

<div class="card">
  <h1 id="question">Loading...</h1>

  <div class="bar-container">
    <div class="label" id="labelA">Option A - 0 votes</div>
    <div class="bar-bg"><div class="bar barA" id="barA"></div></div>

    <div class="label" id="labelB">Option B - 0 votes</div>
    <div class="bar-bg"><div class="bar barB" id="barB"></div></div>
  </div>

  <div class="nav">
    <button id="prevBtn">⬅ Previous</button>
    <button id="nextBtn">Next ➡</button>
  </div>
</div>

<script>
const API_BASE = "https://b9gzcub1b9.execute-api.eu-north-1.amazonaws.com";
const WS_URL = "wss://u3wsnkcxnj.execute-api.eu-north-1.amazonaws.com/production";

let polls = [];
let results = {}; // results[pollID] = { A, B }
let currentIndex = 0;

// DOM
const questionEl = document.getElementById("question");
const barA = document.getElementById("barA");
const barB = document.getElementById("barB");
const labelA = document.getElementById("labelA");
const labelB = document.getElementById("labelB");

// -------- Init --------

init();

async function init() {
  await loadPolls();
  connectWS();
}

// -------- Data loading --------

async function loadPolls() {
  const res = await fetch(API_BASE + "/polls");
  polls = await res.json();

  const urlGameID = new URLSearchParams(window.location.search).get("gameID");
  const gameID = urlGameID || localStorage.getItem("gameID");
  console.log("ADMIN gameID =", gameID);

  if (!polls.length) {
    questionEl.innerText = "No polls available";
    return;
  }

  // init results to zero
  polls.forEach(p => {
    results[p.pollID] = { A: 0, B: 0 };
  });

  showPoll(0);
}

// -------- UI --------

function showPoll(index) {
  currentIndex = index;
  const poll = polls[index];
  questionEl.innerText = poll.question;
  drawChart(poll.pollID);
}

function drawChart(pollID) {
  const data = results[pollID] || { A: 0, B: 0 };
  const total = data.A + data.B || 1;

  const percentA = Math.round((data.A / total) * 100);
  const percentB = Math.round((data.B / total) * 100);

  barA.style.width = percentA + "%";
  barB.style.width = percentB + "%";

  const poll = polls[currentIndex];
  labelA.innerText = `${poll.options[0]} — ${data.A} votes`;
  labelB.innerText = `${poll.options[1]} — ${data.B} votes`;
}

// -------- Navigation --------

document.getElementById("prevBtn").onclick = () => {
  if (currentIndex > 0) showPoll(currentIndex - 1);
};

document.getElementById("nextBtn").onclick = () => {
  if (currentIndex < polls.length - 1) showPoll(currentIndex + 1);
};

// -------- WebSocket --------

function connectWS() {
  const ws = new WebSocket(WS_URL);

  ws.onopen = () => console.log("Admin WS connected");

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === "results_update") {
      results[msg.pollID] = {
        A: msg.countA,
        B: msg.countB
      };

      // update UI only if this poll is shown
      if (polls[currentIndex]?.pollID === msg.pollID) {
        drawChart(msg.pollID);
      }
      console.log("WS MESSAGE:", event.data);
    }
  };

  ws.onerror = (e) => console.error("WS error", e);
}
</script>
</body>
</html>
